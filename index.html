<!DOCTYPE html>
<html lang="en">
<head>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#218D8D">
<script>if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');</script>


  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Habit Tracker</title>
  <style>
    :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;

  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
}

.gradient1 { background: linear-gradient(100deg, #dbf7fc 0%, #e7fff1 100%); }
.gradient2 { background: linear-gradient(95deg, #ffe2df 0%, #f5f9fb 100%); }
.gradient3 { background: linear-gradient(85deg, #f0fff7 0%, #f3fafc 100%); }
.gradient4 { background: linear-gradient(115deg, #fffbe8 0%, #eafeff 100%); }
.gradient5 { background: linear-gradient(90deg, #ebe2ff 0%, #e9f5fc 100%); }
.gradient6 { background: linear-gradient(105deg, #f5fcfa 0%, #fff8ec 100%); }
.gradient7 { background: linear-gradient(98deg, #f0fcff 0%, #faf7ed 100%); }
.gradient8 { background: linear-gradient(100deg, #f0feec 0%, #edf3fc 100%); }

@media (prefers-color-scheme: dark) {
  .gradient1 { background: linear-gradient(100deg, rgba(33,128,141,0.15) 0%, rgba(50,184,198,0.1) 100%); }
  .gradient2 { background: linear-gradient(95deg, rgba(192,21,47,0.12) 0%, rgba(255,84,89,0.08) 100%); }
  .gradient3 { background: linear-gradient(85deg, rgba(33,128,141,0.18) 0%, rgba(50,184,198,0.12) 100%); }
  .gradient4 { background: linear-gradient(115deg, rgba(245,158,11,0.12) 0%, rgba(33,128,141,0.1) 100%); }
  .gradient5 { background: linear-gradient(90deg, rgba(147,51,234,0.12) 0%, rgba(33,128,141,0.1) 100%); }
  .gradient6 { background: linear-gradient(105deg, rgba(33,128,141,0.12) 0%, rgba(245,158,11,0.1) 100%); }
  .gradient7 { background: linear-gradient(98deg, rgba(6,182,212,0.12) 0%, rgba(33,128,141,0.1) 100%); }
  .gradient8 { background: linear-gradient(100deg, rgba(34,197,94,0.12) 0%, rgba(33,128,141,0.1) 100%); }
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-family-base);
  background-color: var(--color-background);
  color: var(--color-text);
  line-height: var(--line-height-normal);
  font-size: var(--font-size-base);
}

.app-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.header {
  background-color: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  padding: var(--space-16) var(--space-24);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--space-24);
  flex-wrap: wrap;
}

.header-title {
  display: flex;
  align-items: center;
  gap: var(--space-12);
}

.header-title h1 {
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-text);
}

.month-display {
  font-size: var(--font-size-lg);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
}

.header-controls {
  display: flex;
  gap: var(--space-12);
  align-items: center;
  flex-wrap: wrap;
}

.control-group {
  display: flex;
  gap: var(--space-8);
  align-items: center;
}

.control-group label {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text-secondary);
}

.control-group input,
.control-group select {
  padding: var(--space-6) var(--space-12);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  background-color: var(--color-surface);
  color: var(--color-text);
  font-size: var(--font-size-sm);
  font-family: var(--font-family-base);
}

.control-group input:focus,
.control-group select:focus {
  outline: var(--focus-outline);
  border-color: var(--color-primary);
}

.btn {
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  border: none;
  font-family: var(--font-family-base);
}

.btn-primary {
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.btn-primary:hover {
  background-color: var(--color-primary-hover);
}

.btn-secondary {
  background-color: var(--color-secondary);
  color: var(--color-text);
  border: 1px solid var(--color-border);
}

.btn-secondary:hover {
  background-color: var(--color-secondary-hover);
}

.btn-danger {
  background-color: var(--color-error);
  color: var(--color-white);
}

.btn-danger:hover {
  opacity: 0.9;
}

.main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.sidebar {
  background-color: var(--color-surface);
  border-right: 1px solid var(--color-border);
  padding: var(--space-24);
  overflow-y: auto;
  min-width: 280px;
  max-width: 320px;
}

.sidebar-title {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-16);
  color: var(--color-text);
}

.habit-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
}

.habit-item {
  display: flex;
  flex-direction: column;
  padding: var(--space-12);
  background-color: var(--color-background);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  gap: var(--space-8);
  transition: box-shadow var(--duration-fast), transform var(--duration-fast);
  position: relative;
  min-height: 44px;
}

.habit-item:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.habit-mini-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: var(--radius-full);
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
  font-weight: var(--font-weight-bold);
}

.habit-header {
  display: flex;
  align-items: center;
  gap: var(--space-8);
}

.habit-emoji {
  font-size: var(--font-size-xl);
}

.habit-name-input,
.habit-category-input {
  flex: 1;
  padding: var(--space-4) var(--space-8);
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  background-color: transparent;
  color: var(--color-text);
  font-size: var(--font-size-sm);
  font-family: var(--font-family-base);
  font-weight: var(--font-weight-medium);
}

.habit-name-input:hover,
.habit-category-input:hover {
  background-color: var(--color-secondary);
}

.habit-name-input:focus,
.habit-category-input:focus {
  outline: none;
  border-color: var(--color-primary);
  background-color: var(--color-surface);
}

.habit-category-input {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-normal);
}

.habit-progress {
  display: flex;
  align-items: center;
  gap: var(--space-8);
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

.progress-bar {
  flex: 1;
  height: 6px;
  background-color: var(--color-secondary);
  border-radius: var(--radius-full);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background-color: var(--color-primary);
  transition: width var(--duration-normal) var(--ease-standard);
}

.add-habit-btn {
  margin-top: var(--space-16);
  width: 100%;
}

.tracker-grid {
  flex: 1;
  overflow-x: auto;
  overflow-y: auto;
  padding: var(--space-24);
  position: relative;
  -webkit-overflow-scrolling: touch;
}

.grid-table {
  width: max-content;
  min-width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  overflow: visible;
}

.grid-table th,
.grid-table td {
  padding: var(--space-12);
  text-align: center;
  border-right: 1px solid var(--color-border);
  border-bottom: 1px solid var(--color-border);
}

.grid-table th {
  background-color: var(--color-bg-1);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-sm);
  color: var(--color-text);
  position: sticky;
  top: 0;
  z-index: 10;
}

.grid-table th.today-column {
  background: linear-gradient(135deg, var(--color-bg-3) 0%, var(--color-bg-1) 100%);
  position: relative;
}

.grid-table th.today-column::after {
  content: 'üî¥';
  position: absolute;
  top: 4px;
  right: 6px;
  font-size: 8px;
  animation: todayPulse 2s ease-in-out infinite;
}

@keyframes todayPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.2); }
}

.grid-table td:nth-child(1),
.grid-table td:nth-child(2),
.grid-table td:nth-child(3) {
  box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
}

.grid-table th:nth-child(1),
.grid-table th:nth-child(2),
.grid-table th:nth-child(3) {
  box-shadow: 2px 0 4px rgba(0, 0, 0, 0.08);
}

.grid-table tr:last-child td {
  border-bottom: none;
}

.grid-table td:last-child,
.grid-table th:last-child {
  border-right: none;
}

.day-header {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.day-name {
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-xs);
  text-transform: uppercase;
}

.day-number {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.checkbox-cell {
  cursor: pointer;
  user-select: none;
}

.checkbox-wrapper {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border: 2px solid var(--color-border);
  border-radius: var(--radius-sm);
  transition: all var(--duration-fast) var(--ease-standard);
  background-color: var(--color-surface);
}

.checkbox-wrapper:hover {
  border-color: var(--color-primary);
  background-color: var(--color-bg-3);
  transform: scale(1.15);
  box-shadow: 0 0 0 4px rgba(50,184,198,0.15);
}

.checkbox-wrapper.checked {
  background-color: var(--color-primary);
  border-color: var(--color-primary);
  animation: checkPulse 0.3s ease-out;
}

@keyframes checkPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.25); }
  100% { transform: scale(1); }
}

.checkbox-wrapper.checked::after {
  content: '‚úì';
  color: var(--color-btn-primary-text);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-bold);
}

.stats-sidebar {
  background-color: var(--color-surface);
  border-left: 1px solid var(--color-border);
  padding: var(--space-24);
  overflow-y: auto;
  min-width: 280px;
  max-width: 320px;
}

.stats-card {
  background-color: var(--color-background);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-base);
  padding: var(--space-16);
  margin-bottom: var(--space-16);
}

.stats-card-title {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-12);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stats-value {
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-text);
  margin-bottom: var(--space-8);
}

.stats-label {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

.overall-progress {
  margin-bottom: var(--space-24);
}

.overall-progress .progress-bar {
  height: 12px;
  margin-bottom: var(--space-8);
}

.top-habits-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
}

.top-habit-item {
  display: flex;
  align-items: center;
  gap: var(--space-8);
  padding: var(--space-8);
  background-color: var(--color-bg-3);
  border-radius: var(--radius-sm);
}

.top-habit-emoji {
  font-size: var(--font-size-lg);
}

.top-habit-info {
  flex: 1;
}

.top-habit-name {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text);
}

.top-habit-progress {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

.hidden {
  display: none;
}

.view-tabs {
  display: flex;
  gap: var(--space-8);
  background-color: var(--color-secondary);
  padding: var(--space-4);
  border-radius: var(--radius-base);
  box-shadow: var(--shadow-sm);
}

.tab-btn {
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  border: none;
  background: transparent;
  color: var(--color-text);
  font-family: var(--font-family-base);
}

.tab-btn.active {
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
  box-shadow: 0 2px 8px rgba(33,128,141,0.25);
  transform: translateY(-1px);
}

.tab-btn:hover:not(.active) {
  background-color: var(--color-secondary-hover);
}

.view-container {
  flex: 1;
  overflow: auto;
}

.yearly-content {
  padding: var(--space-24);
  max-width: 1400px;
  margin: 0 auto;
}

.section-title {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--space-24);
  color: var(--color-text);
}

.section-subtitle {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-16);
  margin-top: var(--space-32);
  color: var(--color-text);
}

.chart-section {
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  margin-bottom: var(--space-32);
}

.chart-container {
  position: relative;
  height: 400px;
}

.chart-container-small {
  position: relative;
  height: 300px;
}

.month-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: var(--space-16);
  margin-bottom: var(--space-24);
}

.month-card {
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  padding: var(--space-16);
  text-align: center;
  transition: box-shadow var(--duration-fast);
  border-width: 2px;
  border-style: solid;
  position: relative;
  overflow: hidden;
}

.month-card:hover {
  box-shadow: var(--shadow-md);
}

.month-card-name {
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-8);
  text-transform: uppercase;
}

.month-card-value {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
}

.month-rank-1 { border-color: var(--color-success); background: linear-gradient(107deg, #dbfff4 0%, #e8f6fa 100%); }
.month-rank-2 { border-color: var(--color-warning); background: linear-gradient(107deg, #fffadb 0%, #fbf6e8 100%); }
.month-rank-3 { border-color: #FFC185; }
.month-rank-low { border-color: var(--color-error); background: linear-gradient(113deg, #ffeaea 0%, #f8fafd 100%); }

.month-card-badge {
  position: absolute;
  right: 12px;
  top: 10px;
  font-size: 1.25rem;
  opacity: 0.9;
  z-index: 3;
}

.top-performers-section {
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
}

.top-performers-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
}

.performer-item {
  display: flex;
  align-items: center;
  gap: var(--space-16);
  padding: var(--space-16);
  background-color: var(--color-background);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: box-shadow var(--duration-fast);
}

.performer-item:hover {
  box-shadow: var(--shadow-sm);
}

.performer-emoji {
  font-size: var(--font-size-3xl);
}

.performer-info {
  flex: 1;
}

.performer-name {
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  margin-bottom: var(--space-4);
}

.performer-category {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.performer-progress {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
}

.enhanced-preview-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: var(--space-16);
  margin-bottom: var(--space-24);
  margin-top: var(--space-16);
}

.preview-card {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-16);
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  position: relative;
  overflow: hidden;
  min-height: 110px;
  transition: box-shadow var(--duration-normal), transform var(--duration-normal);
  border: 1.5px solid var(--color-card-border-inner);
}

.preview-card:hover {
  transform: translateY(-3px) scale(1.025);
  box-shadow: 0 10px 36px -6px rgba(50,184,198,0.22);
}

.preview-badge {
  font-size: 1.6rem;
  margin-bottom: var(--space-8);
}

.preview-label {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
  margin-bottom: var(--space-4);
  text-transform: uppercase;
  letter-spacing: .7px;
}

.preview-value {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
  text-shadow: 0 1px 7px rgba(33,128,132,.07);
}

.circular-progress {
  position: relative;
  width: 100px;
  height: 100px;
  margin: var(--space-12) auto;
}

.circular-progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-text);
}

.enhanced-card {
  background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-background) 100%);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-md);
}

.enhanced-card:hover {
  box-shadow: var(--shadow-lg);
}

#monthlyView {
  display: flex;
}

@media (max-width: 1200px) {
  .stats-sidebar {
    display: block;
  }
}

/* MOBILE SIDEBAR STYLES */
@media (max-width: 700px) {
  .main-content {
    flex-direction: column;
  }
  .sidebar {
    position: fixed!important;
    top: 56px;
    left: 0;
    z-index: 2000;
    background: var(--color-surface);
    height: 100vh;
    min-width: 0!important;
    max-width: none!important;
    width: 88vw;
    box-shadow: 0 6px 16px rgba(33,128,141,0.12);
    display: none;
    padding: 0;
    overflow-y: auto;
  }
  .sidebar.open {
    display: block!important;
    animation: slideInSidebar 240ms var(--ease-standard);
  }
  .sidebar-inside {
    padding: var(--space-16) 20px 32px 16px;
  }
  #closeSidebarBtn {
    display: block;
  }

  .stats-sidebar {
    position: fixed!important;
    top: 56px;
    right: 0;
    z-index: 2000;
    background: var(--color-surface);
    height: 100vh;
    min-width: 0!important;
    max-width: none!important;
    width: 88vw;
    box-shadow: 0 6px 16px rgba(33,128,141,0.12);
    display: none;
    padding: 0;
    overflow-y: auto;
  }
  .stats-sidebar.open {
    display: block!important;
    animation: slideInSidebar 260ms var(--ease-standard);
  }
  .sidebar-inside {
    padding: var(--space-16) 20px 32px 16px;
  }
  #closeStatsBtn {
    display: block;
  }
  #monthlyView > .sidebar:not(.open) {
    display: none!important;
  }
  #monthlyView > .stats-sidebar:not(.open) {
    display: none!important;
  }
  .mobile-controls {
    display: flex!important;
  }
  #monthlySidebar, #monthlyStatsSidebar {
    transition: transform 240ms var(--ease-standard), opacity 180ms var(--ease-standard);
  }
}
@keyframes slideInSidebar {
  0% { opacity: 0; transform: translateX(-60px); }
  100% { opacity: 1; transform: translateX(0); }
}
@keyframes slideInStatsSidebar {
  0% { opacity: 0; transform: translateX(60px); }
  100% { opacity: 1; transform: translateX(0); }
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 200ms var(--ease-standard);
}
.overlay.show {
  opacity: 1;
  pointer-events: auto;
}

@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-12);
  }
  
  .header-controls {
    width: 100%;
    flex-wrap: wrap;
  }
  
  .control-group {
    flex: 1 1 auto;
  }
  
  .btn {
    padding: var(--space-10) var(--space-16);
    font-size: var(--font-size-base);
    min-height: 44px;
  }
  
  .checkbox-wrapper {
    width: 36px;
    height: 36px;
    border-width: 2.5px;
  }
  
  .checkbox-wrapper.checked::after {
    font-size: var(--font-size-lg);
  }
  
  .grid-table th,
  .grid-table td {
    padding: var(--space-12) var(--space-10);
  }
  
  .grid-table th:nth-child(1) {
    min-width: 140px;
  }
  
  .grid-table th:nth-child(2),
  .grid-table th:nth-child(3) {
    min-width: 60px;
  }
  
  .tracker-grid {
    padding: var(--space-12);
  }
  
  .grid-table {
    font-size: var(--font-size-sm);
  }
  
  .grid-table td:nth-child(1) {
    font-size: var(--font-size-sm);
  }
  
  .chart-section {
    padding: var(--space-16)!important;
    margin: var(--space-16)!important;
  }
  
  .chart-container {
    height: 280px!important;
  }
  
  .month-cards-grid {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  }
  
  .enhanced-preview-cards-grid {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
  
  .view-tabs {
    width: 100%;
    justify-content: center;
  }
  
  .tab-btn {
    flex: 1;
    padding: var(--space-10) var(--space-12);
    font-size: var(--font-size-sm);
    min-height: 44px;
  }
}

@media (max-width: 480px) {
  .header-title h1 {
    font-size: var(--font-size-2xl);
  }
  
  .btn {
    font-size: var(--font-size-sm);
    padding: var(--space-8) var(--space-12);
  }
  
  .control-group label {
    font-size: var(--font-size-xs);
  }
  
  .control-group input,
  .control-group select {
    font-size: var(--font-size-xs);
  }
  
  .header {
    padding: var(--space-12) var(--space-16);
  }
  
  .tab-btn {
    font-size: var(--font-size-xs);
    padding: var(--space-8) var(--space-10);
  }
  
  .yearly-content {
    padding: var(--space-16);
  }
  
  .section-title {
    font-size: var(--font-size-xl);
  }
  
  .section-subtitle {
    font-size: var(--font-size-lg);
  }
  
  .enhanced-preview-cards-grid {
    grid-template-columns: 1fr 1fr;
    gap: var(--space-12);
  }
  
  .preview-card {
    padding: var(--space-12);
    min-height: 90px;
  }
  
  .preview-badge {
    font-size: 1.3rem;
  }
  
  .preview-value {
    font-size: var(--font-size-base);
  }
  
  .month-cards-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-12);
  }
  
  .month-card {
    padding: var(--space-12);
  }
  
  .month-card-value {
    font-size: var(--font-size-xl);
  }
}
  </style>
</head>
<body>
  <div id="overlay" class="overlay"></div>
  <div class="app-container">
    <header class="header">
      <div class="header-content">
        <div class="header-title">
          <h1>Habit Tracker</h1>
        </div>
        <div class="mobile-controls" id="mobileControls" style="display: none; gap: 12px;">
          <button class="btn btn-secondary" id="showSidebarBtn" aria-label="Show habit list" title="Show Habits" style="font-size:18px;">üìã</button>
          <button class="btn btn-secondary" id="showStatsBtn" aria-label="Show statistics" title="Show Stats" style="font-size:18px;">üìà</button>
        </div>
        <div class="view-tabs">
          <button class="tab-btn active" id="yearlyViewBtn">Yearly Statistics</button>
          <button class="tab-btn" id="monthlyViewBtn">Monthly Tracker</button>
        </div>
        <button class="btn btn-secondary" id="toggleChartBtn" style="display: none;">Switch to Yearly Chart</button>
        <div class="header-controls">
          <div class="control-group">
            <label for="yearInput">Year:</label>
            <input type="number" id="yearInput" min="2000" max="2100" value="2025">
          </div>
          <div class="control-group" id="monthSelectGroup">
            <label for="monthSelect">Month:</label>
            <select id="monthSelect">
              <option value="0">January</option>
              <option value="1">February</option>
              <option value="2">March</option>
              <option value="3">April</option>
              <option value="4">May</option>
              <option value="5">June</option>
              <option value="6">July</option>
              <option value="7">August</option>
              <option value="8">September</option>
              <option value="9">October</option>
              <option value="10">November</option>
              <option value="11">December</option>
            </select>
          </div>
          <button class="btn btn-primary" id="applyBtn">Apply</button>
          <button class="btn btn-secondary" id="exportBtn">Export Data</button>
          <button class="btn btn-secondary" id="importBtn">Import Data</button>
          <input type="file" id="importFile" accept=".json" class="hidden">
          <button class="btn btn-danger" id="resetBtn">Reset All</button>
        </div>
      </div>
    </header>

    <div class="main-content">
      <div id="yearlyView" class="view-container">
        <div class="yearly-content">
          <div class="chart-section">
            <h2 class="section-title">Yearly Progress Overview</h2>
            <div class="enhanced-preview-cards-grid">
              <div class="preview-card gradient1" id="topHabitCard">
                <div class="preview-badge" title="Top Performing Habit">üèÜ</div>
                <div class="preview-label">Best Habit</div>
                <div class="preview-value" id="topHabitValue"></div>
              </div>
              <div class="preview-card gradient2" id="lowHabitCard">
                <div class="preview-badge" title="Lowest Performing Habit">üîª</div>
                <div class="preview-label">Lowest Habit</div>
                <div class="preview-value" id="lowHabitValue"></div>
              </div>
              <div class="preview-card gradient3" id="avgYearCard">
                <div class="preview-badge" title="Average Completion">üìä</div>
                <div class="preview-label">Year Avg</div>
                <div class="preview-value" id="avgYearValue"></div>
              </div>
              <div class="preview-card gradient4" id="bestMonthCard">
                <div class="preview-badge" title="Best Month">üìà</div>
                <div class="preview-label">Best Month</div>
                <div class="preview-value" id="bestMonthValue"></div>
              </div>
              <div class="preview-card gradient5" id="worstMonthCard">
                <div class="preview-badge" title="Worst Month">üìâ</div>
                <div class="preview-label">Worst Month</div>
                <div class="preview-value" id="worstMonthValue"></div>
              </div>
              <div class="preview-card gradient6" id="yoyCard">
                <div class="preview-badge" title="Year-over-Year Comparison">üïë</div>
                <div class="preview-label">YoY Diff</div>
                <div class="preview-value" id="yoyValue"></div>
              </div>
              <div class="preview-card gradient7" id="totalCheckinsCard">
                <div class="preview-badge" title="Check-ins">‚úîÔ∏è</div>
                <div class="preview-label">Check-ins</div>
                <div class="preview-value" id="totalCheckinsValue"></div>
              </div>
              <div class="preview-card gradient8" id="totalPossibleCard">
                <div class="preview-badge" title="Total Possible">üî¢</div>
                <div class="preview-label">Total Possible</div>
                <div class="preview-value" id="totalPossibleValue"></div>
              </div>
            </div>
            <div class="chart-container" style="margin-top: 28px;">
              <canvas id="yearlyChart"></canvas>
            </div>
          </div>
          <div class="monthly-stats-grid">
            <h3 class="section-subtitle">Monthly Statistics</h3>
            <div class="month-cards-grid" id="monthCardsGrid"></div>
          </div>
          <div class="top-performers-section">
            <h3 class="section-subtitle">Top Performing Habits</h3>
            <div class="top-performers-list" id="topPerformersList"></div>
          </div>
        </div>
      </div>

      <div id="monthlyView" class="view-container hidden">
        <aside class="sidebar" id="monthlySidebar">
          <div class="sidebar-inside">
          <button class="btn btn-secondary" id="closeSidebarBtn" style="display: none; margin-bottom: 8px;">Close</button>
          <h2 class="sidebar-title">My Habits</h2>
          <div class="habit-list" id="habitList"></div>
          <button class="btn btn-primary add-habit-btn" id="addHabitBtn">+ Add Habit</button>
          </div>
        </aside>

        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
          <main class="tracker-grid" id="trackerGrid" style="flex: 0 0 auto; max-height: 50vh; overflow-y: auto;"></main>
          
          <div class="chart-section" style="margin: var(--space-24); flex: 1; min-height: 300px;">
            <h3 class="section-subtitle" id="monthlyChartTitle">Monthly Daily Progression</h3>
            <div class="chart-container" style="height: 350px;">
              <canvas id="monthlyProgressChart"></canvas>
            </div>
          </div>
        </div>

        <aside class="stats-sidebar" id="monthlyStatsSidebar">
          <div class="sidebar-inside">
          <button class="btn btn-secondary" id="closeStatsBtn" style="display: none; margin-bottom: 8px;">Close</button>
          <div class="stats-card enhanced-card">
            <div class="stats-card-title">üìä Monthly Progress</div>
            <div class="circular-progress" id="circularProgress">
              <svg width="100" height="100">
                <circle cx="50" cy="50" r="40" fill="none" stroke="var(--color-secondary)" stroke-width="8"></circle>
                <circle id="progressCircle" cx="50" cy="50" r="40" fill="none" stroke="var(--color-primary)" stroke-width="8" 
                  stroke-dasharray="251.2" stroke-dashoffset="251.2" 
                  transform="rotate(-90 50 50)" style="transition: stroke-dashoffset 0.6s var(--ease-standard);"></circle>
              </svg>
              <div class="circular-progress-text" id="overallPercentage">0%</div>
            </div>
            <div class="progress-bar" style="margin-top: var(--space-12);">
              <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
            </div>
          </div>

          <div class="stats-card enhanced-card">
            <div class="stats-card-title">üéØ Active Habits</div>
            <div class="stats-value" id="habitCount">0</div>
            <div class="stats-trend" id="habitTrend" style="font-size:var(--font-size-xs);color:var(--color-text-secondary);margin-top:4px;"></div>
          </div>

          <div class="stats-card enhanced-card">
            <div class="stats-card-title">‚úÖ Total Check-ins</div>
            <div class="stats-value" id="completedCount">0</div>
            <div class="stats-trend" id="checkinTrend" style="font-size:var(--font-size-sm);color:var(--color-success);margin-top:4px;"></div>
          </div>

          <div class="stats-card enhanced-card">
            <div class="stats-card-title">üèÜ Best Habit</div>
            <div class="best-habit-display" id="bestHabitDisplay"></div>
          </div>
          
          <div class="stats-card enhanced-card">
            <div class="stats-card-title">üî• Streak</div>
            <div class="stats-value" id="streakCount">0</div>
            <div class="stats-label">Consecutive days</div>
          </div>
          
          <div class="stats-card enhanced-card">
            <div class="stats-card-title">üìÖ Days Left</div>
            <div class="stats-value" id="daysRemaining">0</div>
            <div class="stats-label">Until month end</div>
          </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentYear = 2025;
    let currentMonth = 10;
    let currentView = 'yearly';
    let monthlyChartMode = 'daily';
    let habits = [
      { id: 1, name: "Wake up early", category: "Health", emoji: "üåÖ", goal: 30 },
      { id: 2, name: "Exercise", category: "Health", emoji: "üí™", goal: 25 },
      { id: 3, name: "Reading", category: "Learning", emoji: "üìö", goal: 20 },
      { id: 4, name: "Meditation", category: "Wellness", emoji: "üßò", goal: 28 },
      { id: 5, name: "No Junk Food", category: "Health", emoji: "ü•ó", goal: 25 },
      { id: 6, name: "Hydrate", category: "Health", emoji: "üíß", goal: 31 }
    ];
    let checkedData = {};
    let nextHabitId = 7;
    let yearlyChart = null;
    let monthlyProgressChart = null;

    const monthNames = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];

    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    function init() {
      const now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth();
      
      document.getElementById('yearInput').value = currentYear;
      document.getElementById('monthSelect').value = currentMonth;
      
      renderAll();
      attachEventListeners();
      setupMobileUI();
    }

    function attachEventListeners() {
      document.getElementById('yearlyViewBtn').addEventListener('click', () => switchView('yearly'));
      document.getElementById('monthlyViewBtn').addEventListener('click', () => switchView('monthly'));
      document.getElementById('toggleChartBtn').addEventListener('click', toggleMonthlyChart);
      
      document.getElementById('applyBtn').addEventListener('click', () => {
        currentYear = parseInt(document.getElementById('yearInput').value);
        currentMonth = parseInt(document.getElementById('monthSelect').value);
        renderAll();
      });

      document.getElementById('addHabitBtn').addEventListener('click', addNewHabit);
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('importFile').click();
      });
      document.getElementById('importFile').addEventListener('change', importData);
      document.getElementById('resetBtn').addEventListener('click', resetAll);

      document.getElementById('showSidebarBtn').addEventListener('click', openSidebar);
      document.getElementById('showStatsBtn').addEventListener('click', openStatsSidebar);
      document.getElementById('closeSidebarBtn').addEventListener('click', closeSidebar);
      document.getElementById('closeStatsBtn').addEventListener('click', closeStatsSidebar);
      const overlay = document.getElementById('overlay');
      if (overlay) {
        overlay.addEventListener('click', () => {
          closeSidebar();
          closeStatsSidebar();
        });
      }
      window.addEventListener('resize', handleResponsiveSidebar);
    }

    function switchView(view) {
      currentView = view;
      
      document.getElementById('yearlyViewBtn').classList.toggle('active', view === 'yearly');
      document.getElementById('monthlyViewBtn').classList.toggle('active', view === 'monthly');
      
      document.getElementById('yearlyView').classList.toggle('hidden', view !== 'yearly');
      document.getElementById('monthlyView').classList.toggle('hidden', view !== 'monthly');
      
      document.getElementById('toggleChartBtn').style.display = view === 'monthly' ? 'inline-block' : 'none';
      
      document.getElementById('monthSelectGroup').classList.toggle('hidden', view === 'yearly');
      
      const mobileControls = document.getElementById('mobileControls');
      if (window.innerWidth <= 700 && view === 'monthly') {
        mobileControls.style.display = 'flex';
      } else {
        mobileControls.style.display = 'none';
      }
      
      closeSidebar();
      closeStatsSidebar();
      
      renderAll();
    }

    function toggleMonthlyChart() {
      monthlyChartMode = monthlyChartMode === 'daily' ? 'yearly' : 'daily';
      const btn = document.getElementById('toggleChartBtn');
      btn.textContent = monthlyChartMode === 'daily' ? 'Switch to Yearly Chart' : 'Switch to Monthly Chart';
      renderMonthlyProgressChart();
    }

    function renderAll() {
      if (currentView === 'yearly') {
        renderYearlyView();
      } else {
        renderHabitList();
        renderTrackerGrid();
        renderStats();
        renderMonthlyProgressChart();
      }
    }

    function renderHabitList() {
      const habitList = document.getElementById('habitList');
      habitList.innerHTML = '';

      habits.forEach(habit => {
        const progress = calculateHabitProgress(habit.id);
        let badge = '';
        if(progress === 100) badge = 'üåü';
        else if(progress >= 80) badge = 'üöÄ';
        else if(progress < 50) badge = 'üí™';
        
        const habitEl = document.createElement('div');
habitEl.className = 'habit-item';
habitEl.innerHTML = `${badge ? `<span class="habit-mini-badge">${badge}</span>` : ''}
  <div class="habit-header">
    <span class="habit-emoji">${habit.emoji}</span>
    <input type="text" class="habit-name-input" value="${habit.name}" data-habit-id="${habit.id}" data-field="name">
    <button class="btn btn-sm btn-danger" onclick="deleteHabit(${habit.id})" style="margin-left: 8px; padding: 4px 8px; font-size: 12px; background-color: #c01530; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Delete this habit">üóëÔ∏è</button>
  </div>

          </div>
          <input type="text" class="habit-category-input" value="${habit.category}" data-habit-id="${habit.id}" data-field="category" placeholder="Category">
          <div class="habit-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            <span>${progress}%</span>
          </div>
        `;
        habitList.appendChild(habitEl);
      });

      document.querySelectorAll('.habit-name-input, .habit-category-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const habitId = parseInt(e.target.dataset.habitId);
          const field = e.target.dataset.field;
          const habit = habits.find(h => h.id === habitId);
          if (habit) {
            habit[field] = e.target.value;
            renderStats();
          }
        });
      });
    }

    function calculateHabitProgress(habitId) {
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const monthData = getMonthData(currentYear, currentMonth);
      const checked = monthData[habitId] || {};
      let count = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        if (checked[day]) count++;
      }
      return Math.round((count / daysInMonth) * 100);
    }
    
    function getMonthData(year, month) {
      if (!checkedData[year]) checkedData[year] = {};
      if (!checkedData[year][month]) checkedData[year][month] = {};
      return checkedData[year][month];
    }
    
    function calculateMonthProgress(year, month) {
      const daysInMonth = getDaysInMonth(year, month);
      const monthData = getMonthData(year, month);
      let total = 0;
      let checked = 0;
      
      habits.forEach(habit => {
        for (let day = 1; day <= daysInMonth; day++) {
          total++;
          if (monthData[habit.id] && monthData[habit.id][day]) {
            checked++;
          }
        }
      });
      
      return total > 0 ? Math.round((checked / total) * 100) : 0;
    }

    function getDaysInMonth(year, month) {
      return new Date(year, month + 1, 0).getDate();
    }

    function getFirstDayOfMonth(year, month) {
      return new Date(year, month, 1).getDay();
    }

    function renderTrackerGrid() {
      const grid = document.getElementById('trackerGrid');
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      
      grid.innerHTML = '';

      const monthData = getMonthData(currentYear, currentMonth);

      const table = document.createElement('table');
      table.className = 'grid-table';
      table.style.width = 'max-content';
      table.style.minWidth = '100%';

      const thead = document.createElement('thead');
      
      // First header row: Day names (calendar-accurate)
      const dayNameRow = document.createElement('tr');
      
      // Empty cells for sticky columns
      const emptyCell1 = document.createElement('th');
      emptyCell1.rowSpan = 2;
      emptyCell1.textContent = 'Habit';
      emptyCell1.style.minWidth = '180px';
      emptyCell1.style.position = 'sticky';
      emptyCell1.style.left = '0';
      emptyCell1.style.zIndex = '20';
      emptyCell1.style.backgroundColor = 'var(--color-bg-1)';
      emptyCell1.style.verticalAlign = 'middle';
      dayNameRow.appendChild(emptyCell1);
      
      const emptyCell2 = document.createElement('th');
      emptyCell2.rowSpan = 2;
      emptyCell2.textContent = 'Goal';
      emptyCell2.style.minWidth = '70px';
      emptyCell2.style.position = 'sticky';
      emptyCell2.style.left = '180px';
      emptyCell2.style.zIndex = '20';
      emptyCell2.style.backgroundColor = 'var(--color-bg-1)';
      emptyCell2.style.verticalAlign = 'middle';
      dayNameRow.appendChild(emptyCell2);
      
      const emptyCell3 = document.createElement('th');
      emptyCell3.rowSpan = 2;
      emptyCell3.textContent = 'Done';
      emptyCell3.style.minWidth = '70px';
      emptyCell3.style.position = 'sticky';
      emptyCell3.style.left = '250px';
      emptyCell3.style.zIndex = '20';
      emptyCell3.style.backgroundColor = 'var(--color-bg-1)';
      emptyCell3.style.verticalAlign = 'middle';
      dayNameRow.appendChild(emptyCell3);
      
      // Day names for each day - CALENDAR ACCURATE
      // Calculate what day of the week each date falls on
      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(currentYear, currentMonth, day);
        const dayOfWeek = dateObj.getDay(); // 0=Sunday, 1=Monday, etc.
        const dayName = dayNames[dayOfWeek];
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        const nameCell = document.createElement('th');
        nameCell.textContent = dayName;
        nameCell.style.minWidth = '45px';
        nameCell.style.maxWidth = '45px';
        nameCell.style.padding = 'var(--space-6) var(--space-4)';
        nameCell.style.fontSize = 'var(--font-size-xs)';
        nameCell.style.fontWeight = 'var(--font-weight-semibold)';
        nameCell.style.textTransform = 'uppercase';
        nameCell.style.borderBottom = '1px solid var(--color-border)';
        
        if (isWeekend) {
          nameCell.style.backgroundColor = 'rgba(var(--color-slate-500-rgb), 0.12)';
          nameCell.style.color = 'var(--color-text-secondary)';
        } else {
          nameCell.style.backgroundColor = 'var(--color-bg-1)';
        }
        
        dayNameRow.appendChild(nameCell);
      }
      
      // Second header row: Day numbers
      const headerRow = document.createElement('tr');
      
      // Day numbers row
      for (let day = 1; day <= daysInMonth; day++) {
        const today = new Date();
        const isToday = (today.getFullYear()===currentYear && today.getMonth()===currentMonth && today.getDate()===day);
        const dateObj = new Date(currentYear, currentMonth, day);
        const dayOfWeek = dateObj.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        const dayHeader = document.createElement('th');
        if (isToday) dayHeader.className = 'today-column';
        dayHeader.style.minWidth = '45px';
        dayHeader.style.maxWidth = '45px';
        dayHeader.style.padding = 'var(--space-8) var(--space-4)';
        
        if (isWeekend) {
          dayHeader.style.backgroundColor = 'rgba(var(--color-slate-500-rgb), 0.12)';
        } else {
          dayHeader.style.backgroundColor = 'var(--color-bg-1)';
        }
        
        const dayNumberDiv = document.createElement('div');
        dayNumberDiv.textContent = day;
        dayNumberDiv.style.fontWeight = isToday ? 'var(--font-weight-bold)' : 'var(--font-weight-semibold)';
        dayNumberDiv.style.color = isToday ? 'var(--color-primary)' : (isWeekend ? 'var(--color-text-secondary)' : 'var(--color-text)');
        dayNumberDiv.style.fontSize = 'var(--font-size-sm)';
        
        dayHeader.appendChild(dayNumberDiv);
        headerRow.appendChild(dayHeader);
      }
      
      thead.appendChild(dayNameRow);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      habits.forEach(habit => {
        const row = document.createElement('tr');
        
        let timesDone = 0;
        for (let day = 1; day <= daysInMonth; day++) {
          if (monthData[habit.id] && monthData[habit.id][day]) timesDone++;
        }
        
        // Sticky name cell
        const nameCell = document.createElement('td');
        nameCell.style.textAlign = 'left';
        nameCell.style.position = 'sticky';
        nameCell.style.left = '0';
        nameCell.style.backgroundColor = 'var(--color-surface)';
        nameCell.style.zIndex = '10';
        nameCell.style.fontWeight = 'var(--font-weight-medium)';
        nameCell.innerHTML = `${habit.emoji} ${habit.name}`;
        row.appendChild(nameCell);
        
        // Sticky goal cell
        const goalCell = document.createElement('td');
        goalCell.style.position = 'sticky';
        goalCell.style.left = '180px';
        goalCell.style.backgroundColor = 'var(--color-surface)';
        goalCell.style.zIndex = '10';
        goalCell.innerHTML = `<input type="number" class="goal-input" value="${habit.goal || daysInMonth}" data-habit-id="${habit.id}" min="1" max="${daysInMonth}" style="width: 50px; padding: 4px 6px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: var(--color-surface); color: var(--color-text); text-align: center; font-size: var(--font-size-sm);">`;
        row.appendChild(goalCell);
        
        // Sticky done cell
        const timesCell = document.createElement('td');
        timesCell.style.position = 'sticky';
        timesCell.style.left = '250px';
        timesCell.style.backgroundColor = 'var(--color-surface)';
        timesCell.style.zIndex = '10';
        const goalValue = habit.goal || daysInMonth;
        const progressColor = timesDone >= goalValue ? 'var(--color-success)' : (timesDone >= goalValue * 0.5 ? 'var(--color-warning)' : 'var(--color-error)');
        timesCell.innerHTML = `<span style="font-weight: var(--font-weight-bold); color: ${progressColor}; font-size: var(--font-size-sm);">${timesDone}/${goalValue}</span>`;
        row.appendChild(timesCell);
        
        // Separate day cells
        for (let day = 1; day <= daysInMonth; day++) {
          const isChecked = monthData[habit.id] && monthData[habit.id][day];
          const dateObj = new Date(currentYear, currentMonth, day);
          const dayOfWeek = dateObj.getDay();
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
          
          const cell = document.createElement('td');
          cell.className = 'checkbox-cell';
          cell.style.minWidth = '45px';
          cell.style.maxWidth = '45px';
          cell.style.padding = 'var(--space-8) var(--space-4)';
          
          if (isWeekend) {
            cell.style.backgroundColor = 'rgba(var(--color-slate-500-rgb), 0.08)';
          }
          
          cell.innerHTML = `<div class="checkbox-wrapper ${isChecked ? 'checked' : ''}" data-habit-id="${habit.id}" data-day="${day}"></div>`;
          row.appendChild(cell);
        }
        
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      grid.appendChild(table);

      document.querySelectorAll('.checkbox-wrapper').forEach(checkbox => {
        checkbox.addEventListener('click', (e) => {
          const habitId = parseInt(e.target.dataset.habitId);
          const day = parseInt(e.target.dataset.day);
          toggleCheckbox(habitId, day);
        });
      });
      
      document.querySelectorAll('.goal-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const habitId = parseInt(e.target.dataset.habitId);
          const habit = habits.find(h => h.id === habitId);
          if (habit) {
            habit.goal = parseInt(e.target.value) || daysInMonth;
            renderAll();
          }
        });
      });
    }

    function toggleCheckbox(habitId, day) {
      const monthData = getMonthData(currentYear, currentMonth);
      if (!monthData[habitId]) {
        monthData[habitId] = {};
      }
      monthData[habitId][day] = !monthData[habitId][day];
      renderAll();
    }

    function renderStats() {
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const monthData = getMonthData(currentYear, currentMonth);
      let totalPossible = habits.length * daysInMonth;
      let totalChecked = 0;

      habits.forEach(habit => {
        for (let day = 1; day <= daysInMonth; day++) {
          if (monthData[habit.id] && monthData[habit.id][day]) {
            totalChecked++;
          }
        }
      });

      const overallPercentage = totalPossible > 0 ? Math.round((totalChecked / totalPossible) * 100) : 0;
      document.getElementById('overallPercentage').textContent = `${overallPercentage}%`;
      document.getElementById('overallProgressBar').style.width = `${overallPercentage}%`;
      
      const circle = document.getElementById('progressCircle');
      const circumference = 2 * Math.PI * 40;
      const offset = circumference - (overallPercentage / 100) * circumference;
      circle.style.strokeDashoffset = offset;

      document.getElementById('habitCount').textContent = habits.length;
      document.getElementById('completedCount').textContent = totalChecked;
      
      const prevMonthData = getMonthData(currentYear, currentMonth-1);
      let prevChecked = 0;
      habits.forEach(h => {
        for(let d=1; d<=getDaysInMonth(currentYear,currentMonth-1); d++) {
          if(prevMonthData[h.id] && prevMonthData[h.id][d]) prevChecked++;
        }
      });
      const trend = totalChecked > prevChecked ? `‚Üë +${totalChecked-prevChecked}` : (totalChecked < prevChecked ? `‚Üì ${totalChecked-prevChecked}` : '‚Äî');
      document.getElementById('checkinTrend').innerHTML = `<span>${trend} vs last month</span>`;

      const habitStats = habits.map(habit => ({
        ...habit,
        progress: calculateHabitProgress(habit.id)
      })).sort((a, b) => b.progress - a.progress);

      const bestHabit = habitStats[0];
      const bestHabitDisplay = document.getElementById('bestHabitDisplay');
      if (bestHabit) {
        let badge = bestHabit.progress===100 ? 'üåü Perfect!' : (bestHabit.progress>=80 ? 'üöÄ Great!' : 'üí™ Keep going!');
        bestHabitDisplay.innerHTML = `
          <div style="display: flex; align-items: center; gap: var(--space-8); margin-top: var(--space-8);">
            <span style="font-size: var(--font-size-2xl);">${bestHabit.emoji}</span>
            <div>
              <div style="font-weight: var(--font-weight-semibold); color: var(--color-text);">${bestHabit.name}</div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">${bestHabit.progress}% &nbsp; ${badge}</div>
            </div>
          </div>
        `;
      }
      
      let streak = 0;
      for (let d = daysInMonth; d >= 1; d--) {
        let hasActivity = false;
        habits.forEach(h => {
          if(monthData[h.id] && monthData[h.id][d]) hasActivity=true;
        });
        if(hasActivity) streak++; else break;
      }
      document.getElementById('streakCount').textContent = streak;
      
      const today = new Date();
      const remaining = (today.getFullYear()===currentYear && today.getMonth()===currentMonth) ? daysInMonth - today.getDate() : daysInMonth;
      document.getElementById('daysRemaining').textContent = remaining;
    }

    function addNewHabit() {
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const newHabit = {
        id: nextHabitId++,
        name: "New Habit",
        category: "General",
        emoji: "‚≠ê",
        goal: daysInMonth
      };
      habits.push(newHabit);
      checkedData[newHabit.id] = {};
      renderAll();
    }

    function renderYearlyView() {
      renderYearlyStatsPreviewCards();
      renderYearlyChart();
      renderMonthCards();
      renderTopPerformers();
    }

    function renderYearlyStatsPreviewCards() {
      const yearTotals = { totalPossible: 0, totalCheckins: 0 };
      const habitStats = habits.map(habit => {
        let total = 0, checked = 0;
        for (let m = 0; m < 12; m++) {
          const daysInMonth = getDaysInMonth(currentYear, m);
          yearTotals.totalPossible += daysInMonth;
          const monthData = getMonthData(currentYear, m);
          for (let d = 1; d <= daysInMonth; d++) {
            total++;
            if (monthData[habit.id] && monthData[habit.id][d]) {
              checked++;
              yearTotals.totalCheckins++;
            }
          }
        }
        return { ...habit, checked, total, percent: (total ? Math.round((checked / total) * 100) : 0) };
      });
      
      let sorted = habitStats.slice().sort((a, b) => b.percent - a.percent);
      const top = sorted[0];
      const low = sorted[sorted.length-1];
      
      const avgYear = yearTotals.totalPossible ? Math.round(yearTotals.totalCheckins / (yearTotals.totalPossible * habits.length) * 100 * habits.length) / habits.length : 0;
      
      const monthProgress = [];
      for (let m = 0; m < 12; m++) {
        let totalM = habits.length * getDaysInMonth(currentYear, m), checkedM = 0;
        const dataM = getMonthData(currentYear, m);
        habits.forEach(h => {
          for (let d = 1; d <= getDaysInMonth(currentYear, m); d++) {
            if (dataM[h.id] && dataM[h.id][d]) checkedM++;
          }
        });
        monthProgress[m] = totalM ? checkedM / totalM : 0;
      }
      let maxIdx = 0, minIdx = 0, max = monthProgress[0], min = monthProgress[0];
      for (let i=1; i<monthProgress.length; i++) {
        if (monthProgress[i] > max) { max = monthProgress[i]; maxIdx = i; }
        if (monthProgress[i] < min) { min = monthProgress[i]; minIdx = i; }
      }
      
      let prevYear = currentYear - 1;
      let prevTotals = { tp: 0, tc: 0 };
      for (let m = 0; m < 12; m++) {
        const days = getDaysInMonth(prevYear, m);
        prevTotals.tp += days * habits.length;
        const monthD = getMonthData(prevYear, m);
        habits.forEach(habit => {
          for (let d=1; d<=days; d++) {
            if (monthD[habit.id] && monthD[habit.id][d]) prevTotals.tc++;
          }
        });
      }
      let prevCompletion = prevTotals.tp > 0 ? Math.round((prevTotals.tc / prevTotals.tp) * 100) : null;
      let thisCompletion = yearTotals.totalPossible > 0 ? Math.round((yearTotals.totalCheckins / (yearTotals.totalPossible*habits.length)) * 100 * habits.length) / habits.length : 0;
      let diff = (prevCompletion!==null) ? (thisCompletion-prevCompletion) : '‚Äî';
      
      document.getElementById('topHabitValue').textContent = top ? `${top.emoji} ${top.name} (${top.percent}%)` : '‚Äî';
      document.getElementById('lowHabitValue').textContent = low && low.id!==top.id ? `${low.emoji} ${low.name} (${low.percent}%)` : '‚Äî';
      document.getElementById('avgYearValue').textContent = avgYear ? `${avgYear}%` : '‚Äî';
      document.getElementById('bestMonthValue').textContent = max > 0 ? `${monthNames[maxIdx]} (${Math.round(max*100)}%)` : '‚Äî';
      document.getElementById('worstMonthValue').textContent = min > 0 ? `${monthNames[minIdx]} (${Math.round(min*100)}%)` : '‚Äî';
      document.getElementById('yoyValue').textContent = (typeof diff === 'number') ? `${diff>0?"+":""}${diff}%` : '‚Äî';
      document.getElementById('totalCheckinsValue').textContent = yearTotals.totalCheckins;
      document.getElementById('totalPossibleValue').textContent = yearTotals.totalPossible*habits.length;
    }

    function renderYearlyChart() {
      const ctx = document.getElementById('yearlyChart').getContext('2d');
      
      const datasets = habits.map((habit, index) => {
        const colors = ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545', '#D2BA4C', '#964325', '#944454', '#13343B'];
        const data = [];
        
        for (let month = 0; month < 12; month++) {
          const daysInMonth = getDaysInMonth(currentYear, month);
          const monthData = getMonthData(currentYear, month);
          let checked = 0;
          for (let day = 1; day <= daysInMonth; day++) {
            if (monthData[habit.id] && monthData[habit.id][day]) checked++;
          }
          const pct = daysInMonth ? Math.round((checked / daysInMonth) * 100) : 0;
          data.push(pct);
        }
        
        return {
          label: `${habit.emoji} ${habit.name}`,
          data: data,
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length],
          tension: 0.4,
          fill: false,
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: colors[index % colors.length],
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        };
      });
      
      if (yearlyChart) {
        yearlyChart.destroy();
      }
      
      yearlyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthNames,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 13 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(31, 33, 33, 0.95)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              borderColor: 'rgba(50, 184, 198, 0.5)',
              borderWidth: 1,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(167, 169, 169, 0.1)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderMonthCards() {
      const grid = document.getElementById('monthCardsGrid');
      grid.innerHTML = '';
      
      const progressValues = monthNames.map((_, i) => calculateMonthProgress(currentYear,i));
      const sorted = progressValues.slice().sort((a,b)=>b-a);
      
      monthNames.forEach((month, idx) => {
        const progress = progressValues[idx];
        let rank = sorted.indexOf(progress)+1;
        let pc = 'month-card';
        let badge = '';
        if(rank===1) { pc+=' month-rank-1'; badge='ü•á'; }
        else if(rank===2) { pc+=' month-rank-2'; badge='ü•à'; }
        else if(rank===3) { pc+=' month-rank-3'; badge='ü•â'; }
        if(progress<=49) pc+=' month-rank-low';
        
        grid.innerHTML += `
          <div class="${pc}">
            <span class="month-card-badge">${badge||' '}</span>
            <div class="month-card-name">${month.substring(0,3)}</div>
            <div class="month-card-value">${progress}%</div>
            <div class="month-card-rank-text" style="margin-top:8px;font-size:11px;color:var(--color-text-secondary);">Rank&nbsp;#${rank}</div>
          </div>`;
      });
    }

    function renderTopPerformers() {
      const yearlyStats = habits.map(habit => {
        let totalProgress = 0;
        for (let month = 0; month < 12; month++) {
          const daysInMonth = getDaysInMonth(currentYear, month);
          const monthData = getMonthData(currentYear, month);
          const checked = monthData[habit.id] || {};
          let count = 0;
          for (let day = 1; day <= daysInMonth; day++) {
            if (checked[day]) count++;
          }
          totalProgress += (count / daysInMonth) * 100;
        }
        return {
          ...habit,
          avgProgress: Math.round(totalProgress / 12)
        };
      }).sort((a, b) => b.avgProgress - a.avgProgress);
      
      const list = document.getElementById('topPerformersList');
      list.innerHTML = '';
      
      yearlyStats.forEach(habit => {
        const item = document.createElement('div');
        item.className = 'performer-item';
        item.innerHTML = `
          <span class="performer-emoji">${habit.emoji}</span>
          <div class="performer-info">
            <div class="performer-name">${habit.name}</div>
            <div class="performer-category">${habit.category}</div>
          </div>
          <div class="performer-progress">${habit.avgProgress}%</div>
        `;
        list.appendChild(item);
      });
    }

    function renderMonthlyProgressChart() {
      const ctx = document.getElementById('monthlyProgressChart').getContext('2d');
      
      if (monthlyChartMode === 'daily') {
        renderDailyChart(ctx);
      } else {
        renderYearlyChartInMonthly(ctx);
      }
    }

    function renderDailyChart(ctx) {
      const daysInMonth = getDaysInMonth(currentYear, currentMonth);
      const monthData = getMonthData(currentYear, currentMonth);
      
      document.getElementById('monthlyChartTitle').textContent = 'Monthly Daily Progression';
      
      const datasets = habits.map((habit, index) => {
        const colors = ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545', '#D2BA4C', '#964325', '#944454', '#13343B'];
        const data = [];
        
        for (let day = 1; day <= daysInMonth; day++) {
          let count = 0;
          for (let d = 1; d <= day; d++) {
            if (monthData[habit.id] && monthData[habit.id][d]) count++;
          }
          const pct = Math.round((count / day) * 100);
          data.push(pct);
        }
        
        return {
          label: `${habit.emoji} ${habit.name}`,
          data: data,
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length],
          tension: 0.4,
          fill: false,
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: colors[index % colors.length],
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        };
      });
      
      if (monthlyProgressChart) {
        monthlyProgressChart.destroy();
      }
      
      const labels = [];
      for (let i = 1; i <= daysInMonth; i++) labels.push(i);
      
      monthlyProgressChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                padding: 12,
                font: { size: 12 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(31, 33, 33, 0.95)',
              padding: 10,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              borderColor: 'rgba(50, 184, 198, 0.5)',
              borderWidth: 1,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  return `Day ${context[0].label}`;
                },
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(167, 169, 169, 0.1)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Day of Month'
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderYearlyChartInMonthly(ctx) {
      document.getElementById('monthlyChartTitle').textContent = 'Yearly Progress Overview';
      
      const datasets = habits.map((habit, index) => {
        const colors = ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F', '#DB4545', '#D2BA4C', '#964325', '#944454', '#13343B'];
        const data = [];
        
        for (let month = 0; month < 12; month++) {
          const daysInMonth = getDaysInMonth(currentYear, month);
          const monthData = getMonthData(currentYear, month);
          let checked = 0;
          for (let day = 1; day <= daysInMonth; day++) {
            if (monthData[habit.id] && monthData[habit.id][day]) checked++;
          }
          const pct = daysInMonth ? Math.round((checked / daysInMonth) * 100) : 0;
          data.push(pct);
        }
        
        return {
          label: `${habit.emoji} ${habit.name}`,
          data: data,
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length],
          tension: 0.4,
          fill: false,
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: colors[index % colors.length],
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        };
      });
      
      if (monthlyProgressChart) {
        monthlyProgressChart.destroy();
      }
      
      monthlyProgressChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthNames,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                padding: 12,
                font: { size: 12 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(31, 33, 33, 0.95)',
              padding: 10,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              borderColor: 'rgba(50, 184, 198, 0.5)',
              borderWidth: 1,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(167, 169, 169, 0.1)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function exportData() {
  try {
    const exportedMonth = currentMonth;
    const exportedYear = currentYear;
    const exportedMonthName = monthNames[currentMonth];
    const filename = `habits-${exportedYear}-${exportedMonthName}.json`;
    const data = {
      version: 2,
      exportDate: new Date().toISOString(),
      currentYear,
      currentMonth,
      habits,
      checkedData,
      nextHabitId
    };

    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setTimeout(() => URL.revokeObjectURL(url), 100);
    logAndToast('Data exported successfully!');
  } catch (err) {
    console.error('Export error:', err);
    alert('Error exporting data.');
  }
}

    function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = JSON.parse(event.target.result);
      if (data.habits && Array.isArray(data.habits)) habits = data.habits;
      if (data.checkedData && typeof data.checkedData === 'object') checkedData = data.checkedData;
      if (typeof data.currentYear === 'number') currentYear = data.currentYear;
      if (typeof data.currentMonth === 'number') currentMonth = data.currentMonth;
      if (data.nextHabitId) nextHabitId = data.nextHabitId;
      document.getElementById('yearInput').value = currentYear;
      document.getElementById('monthSelect').value = currentMonth;
      renderAll();
      logAndToast('Data imported successfully!');
      console.log('Imported:', data);
    } catch (error) {
      alert('Error importing data. Please check the file format.');
      console.error('Import error:', error);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

    function resetAll() {
  if (confirm('Reset all data for this month?')) {
    // Only clear checkboxes for the current month
debugger;
    const monthData = getMonthData(currentYear, currentMonth);
    for (const habit of habits) {
      if (monthData[habit.id]) {
        for (let day = 1; day <= getDaysInMonth(currentYear, currentMonth); day++) {
          monthData[habit.id][day] = false;
        }
      }
    }
    renderAll();
    logAndToast('Month data reset.');
    console.log('Reset data for year', currentYear, 'month', currentMonth, monthNames[currentMonth]);
  }
}

    // Toast implementation
function logAndToast(msg) {
  console.log(msg);
  showToast(msg);
}

function showToast(msg) {
  let toast = document.getElementById('appToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'appToast';
    toast.style.position = 'fixed';
    toast.style.bottom = '32px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.minWidth = '220px';
    toast.style.background = 'var(--color-primary)';
    toast.style.color = 'var(--color-btn-primary-text)';
    toast.style.padding = '16px 28px';
    toast.style.borderRadius = '10px';
    toast.style.boxShadow = '0 5px 18px rgba(33,128,141,0.20)';
    toast.style.fontSize = '16px';
    toast.style.fontWeight = '600';
    toast.style.opacity = 0;
    toast.style.transition = 'opacity 0.3s ease';
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = 1;
  clearTimeout(toast.__timeout);
  toast.__timeout = setTimeout(() => {toast.style.opacity = 0;}, 2100);
}

// Mobile sidebar logic


// ==================== AUTO-SAVE & DELETE FUNCTIONS ====================

// DELETE HABIT FUNCTION
function deleteHabit(habitId) {
  if (confirm('Are you sure you want to delete this habit? This action cannot be undone.')) {
    // Remove habit from array
    habits = habits.filter(h => h.id !== habitId);
    
    // Remove habit data
    if (checkedData[habitId]) {
      delete checkedData[habitId];
    }
    
    // Refresh UI
    renderAll();
    logAndToast('Habit deleted successfully!');
    
    // Auto-save
    autoSaveData();
  }
}

// AUTO-SAVE TIMER
let autoSaveTimer = null;

// AUTO-SAVE DATA FUNCTION - Called after any change
function autoSaveData() {
  // Clear existing timer
  clearTimeout(autoSaveTimer);
  
  // Set new timer - save 2 seconds after last change
  autoSaveTimer = setTimeout(() => {
    saveDataToFile();
  }, 2000);
}

// SAVE DATA TO FILE
async function saveDataToFile() {
  try {
    const dataToSave = {
      version: 2,
      exportDate: new Date().toISOString(),
      currentYear,
      currentMonth,
      habits,
      checkedData,
      nextHabitId
    };
    
    const dataStr = JSON.stringify(dataToSave, null, 2);
    
    // Save to localStorage
    localStorage.setItem('habitTrackerData', dataStr);
    console.log('‚úì Data auto-saved successfully!');
  } catch (error) {
    console.error('‚úó Error auto-saving data:', error);
  }
}

// LISTEN FOR PAGE BEFORE UNLOAD - Save data when closing browser
window.addEventListener('beforeunload', () => {
  console.log('Browser closing, saving data...');
  saveDataToFile();
});

// LISTEN FOR MANUAL SAVE (Ctrl+S)
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveDataToFile();
    showToast('Data saved with Ctrl+S!');
  }
});

// LOAD DATA ON PAGE START
function loadSavedData() {
  try {
    const saved = localStorage.getItem('habitTrackerData');
    if (saved) {
      const data = JSON.parse(saved);
      if (data.habits) {
        habits = data.habits;
        checkedData = data.checkedData || {};
        currentYear = data.currentYear || new Date().getFullYear();
        currentMonth = data.currentMonth || new Date().getMonth();
        nextHabitId = data.nextHabitId || 7;
        console.log('‚úì Loaded saved data from localStorage');
        return true;
      }
    }
  } catch (error) {
    console.error('Error loading saved data:', error);
  }
  return false;
}

// ==================== END AUTO-SAVE & DELETE FUNCTIONS ====================


function openSidebar() {
  const sidebar = document.getElementById('monthlySidebar');
  const overlay = document.getElementById('overlay');
  sidebar && sidebar.classList.add('open');
  overlay && overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  const sidebar = document.getElementById('monthlySidebar');
  const overlay = document.getElementById('overlay');
  sidebar && sidebar.classList.remove('open');
  overlay && overlay.classList.remove('show');
  document.body.style.overflow = '';
}
function openStatsSidebar() {
  const statsSidebar = document.getElementById('monthlyStatsSidebar');
  const overlay = document.getElementById('overlay');
  statsSidebar && statsSidebar.classList.add('open');
  overlay && overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
}
function closeStatsSidebar() {
  const statsSidebar = document.getElementById('monthlyStatsSidebar');
  const overlay = document.getElementById('overlay');
  statsSidebar && statsSidebar.classList.remove('open');
  overlay && overlay.classList.remove('show');
  document.body.style.overflow = '';
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

  </script>
</body>
</html>